[tox]
skipsdist=True
requires = tox-conda
envlist =
        # test
        py3{8, 9, 10}


[base]
conda_env = environment.yaml
conda_env_dev = environment-dev.yaml
conda_deps_test =
                pytest

conda_deps_docs =
           sphinx
           sphinx_rtd_theme
           nbsphinx
           ipython
           setuptools-scm

conda_deps_dist_pypi =
           setuptools
           setuptools-scm
           twine
           setuptools_scm_git_archive
           build

conda_deps_dist_conda =
           anaconda-client
           grayskull
           conda-build
           conda-verify
           boa
           setuptools-scm

package_name = {{ cookiecutter.project_slug }}
import_name = {{ cookiecutter.project_slug }}


[testenv]
usedevelop =
           True
conda_env =
          {[base]conda_env}

conda_deps =
           {[base]conda_deps_test}
commands =
         pytest {posargs}



[testenv:docs-{build, release}]
envdir={toxworkdir}/docs
usedevelop = True
conda_env = {[base]conda_env}
conda_deps =
           {[base]conda_deps_docs}
           ghp-import
allowlist_externals =
                    bash
                    open
changedir={toxworkdir}/docs-dist
commands =
         build: bash -c 'rm -rf {toxworkdir}/docs-dist/*'
         build: sphinx-build  --color -b html -d "{toxworkdir}/docs-dist/doctrees" "{toxinidir}/docs"  "{toxworkdir}/docs-dist/html"
         build: open {toxworkdir}/docs-dist/html/index.html
         release: ghp-import -n -m {posargs:'update docs'} -b nist-pages -p {toxworkdir}/docs-dist/html



# create pypi dist
[testenv:dist-pypi-{build, testrelease, release}]
envdir={toxworkdir}/dist-pypi-env
skip_install=True
conda_deps =
           {[base]conda_deps_dist_pypi}
whitelist_externals =
                    echo
                    rm
commands =
         build: rm -rf {toxworkdir}/dist
         build: python -m build --outdir "{toxworkdir}/dist-pypi/"

         testrelease: twine upload --repository testpypi {toxworkdir}/dist-pypi/*
         release: twine upload {toxworkdir}/dist/*

# create conda dist
[testenv:dist-conda-{recipe, build, command}]
envdir={toxworkdir}/dist-conda-env
skip_install=True
conda_deps =
           {[base]conda_deps_dist_conda}
whitelist_externals =
                    echo
                    mkdir
                    cat
                    rm
changedir = {toxworkdir}/dist-conda
commands =
         recipe: rm -rf {toxworkdir}/conda-dist/{[base]package_name}
         recipe: grayskull pypi {[base]package_name}
         recipe: cat mypackage/meta.yaml

         build: rm -rf build
         build: mkdir -p build
         build: conda mambabuild --output-folder=build .
         command: {posargs:python}


# test install from pypi and conda
[testenv:test-dist-{pypi, conda}-py3{8,9,10}]
skip_install = True
usedevelop=False
conda_deps =
           py38: python=3.8
           py39: python=3.9
           py310: python=3.10
           {[base]conda_deps_test}
           conda: {[base]package_name}
deps =
     pypi: {[base]package_name}

allowlist_externals =
                    bash
changedir={envtmpdir}
commands =
         python --version
         python -c 'import {[base]import_name}; print( {[base]import_name}.__version__)'
         bash -ec 'echo $PWD'
         pytest {posargs} {toxinidir}
